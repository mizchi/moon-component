// Generated by wit-bindgen-moonbit

/// Export trait for containers
pub(open) trait Exports {
  count_list(Self, vals : Array[String]) -> Int
  divide(Self, a : Int, b : Int) -> Result[Int, String]
  echo_list_s64(Self, vals : Array[Int64]) -> Array[Int64]
  sum_list(Self, vals : Array[Int]) -> Int
}

let exports_impl : Ref[&Exports?] = { val: None }

pub fn register(impl_ : &Exports) -> Unit {
  exports_impl.val = Some(impl_)
}

pub fn get_exports() -> &Exports {
  guard exports_impl.val is Some(impl_) else {
    abort("exports not registered")
  }
  impl_
}

pub fn wasmExportCountList(vals_ptr : Int, vals_len : Int) -> Int {
  let vals : Array[String] = {
    let arr : Array[String] = Array::new(capacity=vals_len)
    for i = 0; i < vals_len; i = i + 1 {
      let elem_ptr = vals_ptr + i * 8
      arr.push(@cabi.cabi_lift_string(@cabi.cabi_read_i32(elem_ptr), @cabi.cabi_read_i32(elem_ptr + 4)))
    }
    arr
  }
  get_exports().count_list(vals)
}

pub fn wasmExportDivide(a : Int, b : Int) -> Int {
  let result = get_exports().divide(a, b)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 4 + 8)
  match result {
    Ok(val) => {
      @cabi.cabi_write_i32(retptr, 0) // discriminant: Ok
      @cabi.cabi_write_i32(retptr + 4, val)
    }
    Err(e) => {
      @cabi.cabi_write_i32(retptr, 1) // discriminant: Err
      let (ptr, len) = @cabi.cabi_lower_string(e)
      @cabi.cabi_write_i32(retptr + 4, ptr)
      @cabi.cabi_write_i32(retptr + 4 + 4, len)
    }
  }
  retptr
}

pub fn wasmExportEchoListS64(vals_ptr : Int, vals_len : Int) -> Int {
  let vals : Array[Int64] = {
    let arr : Array[Int64] = Array::new(capacity=vals_len)
    for i = 0; i < vals_len; i = i + 1 {
      let elem_ptr = vals_ptr + i * 8
      arr.push(@cabi.cabi_read_i64(elem_ptr))
    }
    arr
  }
  let result = get_exports().echo_list_s64(vals)
  // Lower list to linear memory
  let len = result.length()
  let elem_size = 8
  let ptr = @cabi.cabi_realloc(0, 0, 8, len * elem_size)
  for i, elem in result {
    let elem_ptr = ptr + i * elem_size
    @cabi.cabi_write_i64(elem_ptr, elem)
  }
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  @cabi.cabi_write_i32(retptr, ptr)
  @cabi.cabi_write_i32(retptr + 4, len)
  retptr
}

pub fn wasmExportSumList(vals_ptr : Int, vals_len : Int) -> Int {
  let vals : Array[Int] = {
    let arr : Array[Int] = Array::new(capacity=vals_len)
    for i = 0; i < vals_len; i = i + 1 {
      let elem_ptr = vals_ptr + i * 4
      arr.push(@cabi.cabi_read_i32(elem_ptr))
    }
    arr
  }
  get_exports().sum_list(vals)
}

