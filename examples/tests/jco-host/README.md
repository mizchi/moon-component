# jco Host Integration Test

This directory contains a JavaScript/Node.js host for testing WebAssembly Components generated by moon-component using [jco](https://github.com/bytecodealliance/jco).

## Prerequisites

- Node.js 18+
- pnpm (or npm)

## Setup

```bash
# Install dependencies
pnpm install

# Build types-test component first
cd ../types-test
moon build --target wasm
../../tools/wit-bindgen-mbt/target/release/wit-bindgen-mbt componentize \
  _build/wasm/release/build/src/src.wasm \
  --wit-dir wit \
  -o types-test.component.wasm
```

## Running

```bash
# Transpile and test
pnpm run build-and-test

# Or step by step:
pnpm run transpile  # Generate JS bindings
pnpm run test       # Run tests
```

## Test Coverage

The jco host tests the **WebAssembly Component** through JavaScript bindings:

### Primitives
- `echoS32`: i32 echo
- `echoS64`: i64 echo (BigInt)
- `echoF32`: f32 echo
- `echoF64`: f64 echo
- `echoBool`: bool echo
- `echoString`: string echo

### Enums
- `echoColor`: enum value echo
- `colorName`: enum to string

### Flags
- `hasRead`: check read permission
- `hasWrite`: check write permission
- `echoPermissions`: flags object echo

### Containers
- `sumList`: list sum
- `countList`: list count
- `divide`: result type (ok/err)

### Multi-params
- `add2`, `add3`, `add4`: multiple parameter addition
- `concat3`: string concatenation
- `mixedParams`: mixed type parameters

### Side-effects
- `noReturn`: void return
- `noParamsNoReturn`: no params, void return

## Architecture

```
┌─────────────┐      ┌──────────────────┐      ┌──────────────┐
│  Node.js    │──────│      jco         │──────│  Component   │
│  (test.js)  │      │ (JS transpiler)  │      │    .wasm     │
└─────────────┘      └──────────────────┘      └──────────────┘
       │                     │                        │
       │    JavaScript API   │   WebAssembly Component Model
       └─────────────────────┴────────────────────────┘
```

## Generated Files

After `pnpm run transpile`:

```
src/gen/
├── types-test.js       # Main JS module
├── types-test.d.ts     # TypeScript types
└── types-test.core.wasm # Core wasm (embedded)
```

## Notes

- jco transpiles WebAssembly Components to JavaScript ES modules
- BigInt is used for i64 values in JavaScript
- Enums are represented as string unions
- Flags are represented as objects with boolean properties
- Results use `{ tag: 'ok', val }` or `{ tag: 'err', val }` format
