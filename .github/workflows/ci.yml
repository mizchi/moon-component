name: ci

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH
      - name: Install wasm-tools
        run: |
          curl -LO https://github.com/bytecodealliance/wasm-tools/releases/download/v1.228.0/wasm-tools-1.228.0-x86_64-linux.tar.gz
          tar xzf wasm-tools-1.228.0-x86_64-linux.tar.gz
          mkdir -p ~/.local/bin
          cp wasm-tools-1.228.0-x86_64-linux/wasm-tools ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Moon version
        run: moon version --all
      - run: moon update
      - name: Run unit tests
        run: moon test
      - name: Build native CLI
        run: |
          moon build --target native --release
          cp _build/native/release/build/src/main/main.exe ~/.local/bin/moon-component

      # hello example (export-only, simple)
      - name: Generate hello example
        run: moon-component generate examples/hello/wit/world.wit -p hello -o examples/hello
      - name: Build hello wasm
        run: moon build --target wasm --release
        working-directory: examples/hello
      - name: Componentize hello
        run: moon-component componentize examples/hello/_build/wasm/release/build/impl/impl.wasm --wit-dir examples/hello/wit -o /tmp/hello.component.wasm
      - name: Verify hello component WIT
        run: wasm-tools component wit /tmp/hello.component.wasm

      # wasi-cli example (multi-package imports, retptr patching)
      - name: Generate wasi-cli example
        run: moon-component generate examples/wasi-cli/wit/world.wit --wit examples/wasi-cli/wit -p wasi-cli-demo -o examples/wasi-cli
      - name: Build wasi-cli wasm
        run: moon build --target wasm --release
        working-directory: examples/wasi-cli
      - name: Componentize wasi-cli
        run: moon-component componentize examples/wasi-cli/_build/wasm/release/build/impl/impl.wasm --wit-dir examples/wasi-cli/wit -o /tmp/wasi-cli.component.wasm
      - name: Verify wasi-cli component WIT
        run: wasm-tools component wit /tmp/wasi-cli.component.wasm
