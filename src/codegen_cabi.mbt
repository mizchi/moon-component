/// Canonical ABI generation

///|
fn Generator::generate_cabi(self : Generator) -> Unit {
  let sb = StringBuilder::new()
  sb.write_string("// Canonical ABI helpers - Generated by moon-component\n\n")

  // Inline wasm intrinsics for direct linear memory access
  sb.write_string("///| Load byte from linear memory (i32.load8_u)\n")
  sb.write_string("extern \"wasm\" fn mem_load8(ptr : Int) -> Int =\n")
  sb.write_string(
    "  #|(func (param i32) (result i32) (i32.load8_u (local.get 0)))\n\n",
  )
  sb.write_string("///| Store byte to linear memory (i32.store8)\n")
  sb.write_string(
    "extern \"wasm\" fn mem_store8(ptr : Int, val : Int) -> Unit =\n",
  )
  sb.write_string(
    "  #|(func (param i32 i32) (result i32) (i32.store8 (local.get 0) (local.get 1)) (i32.const 0))\n\n",
  )
  sb.write_string("///| Load i32 from linear memory (i32.load)\n")
  sb.write_string("extern \"wasm\" fn mem_load32(ptr : Int) -> Int =\n")
  sb.write_string(
    "  #|(func (param i32) (result i32) (i32.load (local.get 0)))\n\n",
  )
  sb.write_string("///| Store i32 to linear memory (i32.store)\n")
  sb.write_string(
    "extern \"wasm\" fn mem_store32(ptr : Int, val : Int) -> Unit =\n",
  )
  sb.write_string(
    "  #|(func (param i32 i32) (result i32) (i32.store (local.get 0) (local.get 1)) (i32.const 0))\n\n",
  )
  sb.write_string("///| Load i64 from linear memory (i64.load)\n")
  sb.write_string("extern \"wasm\" fn mem_load64(ptr : Int) -> Int64 =\n")
  sb.write_string(
    "  #|(func (param i32) (result i64) (i64.load (local.get 0)))\n\n",
  )
  sb.write_string("///| Store i64 to linear memory (i64.store)\n")
  sb.write_string(
    "extern \"wasm\" fn mem_store64(ptr : Int, val : Int64) -> Unit =\n",
  )
  sb.write_string(
    "  #|(func (param i32 i64) (result i32) (i64.store (local.get 0) (local.get 1)) (i32.const 0))\n\n",
  )
  sb.write_string("///| Load f32 from linear memory (f32.load)\n")
  sb.write_string("extern \"wasm\" fn mem_load_f32(ptr : Int) -> Float =\n")
  sb.write_string(
    "  #|(func (param i32) (result f32) (f32.load (local.get 0)))\n\n",
  )
  sb.write_string("///| Store f32 to linear memory (f32.store)\n")
  sb.write_string(
    "extern \"wasm\" fn mem_store_f32(ptr : Int, val : Float) -> Unit =\n",
  )
  sb.write_string(
    "  #|(func (param i32 f32) (result i32) (f32.store (local.get 0) (local.get 1)) (i32.const 0))\n\n",
  )
  sb.write_string("///| Load f64 from linear memory (f64.load)\n")
  sb.write_string("extern \"wasm\" fn mem_load_f64(ptr : Int) -> Double =\n")
  sb.write_string(
    "  #|(func (param i32) (result f64) (f64.load (local.get 0)))\n\n",
  )
  sb.write_string("///| Store f64 to linear memory (f64.store)\n")
  sb.write_string(
    "extern \"wasm\" fn mem_store_f64(ptr : Int, val : Double) -> Unit =\n",
  )
  sb.write_string(
    "  #|(func (param i32 f64) (result i32) (f64.store (local.get 0) (local.get 1)) (i32.const 0))\n\n",
  )
  sb.write_string("///| Get current memory size in pages (memory.size)\n")
  sb.write_string("extern \"wasm\" fn mem_size() -> Int =\n")
  sb.write_string("  #|(func (result i32) (memory.size))\n\n")
  sb.write_string("///| Grow memory by pages (memory.grow)\n")
  sb.write_string("extern \"wasm\" fn mem_grow(pages : Int) -> Int =\n")
  sb.write_string(
    "  #|(func (param i32) (result i32) (memory.grow (local.get 0)))\n\n",
  )

  // Current allocation offset - stored in a known location in linear memory
  // We use the first 4 bytes of linear memory to store the heap pointer
  sb.write_string("///| Heap base address (skip first 64KB for safety)\n")
  sb.write_string("let heap_base : Int = 65536\n\n")
  sb.write_string("///| Get current heap offset\n")
  sb.write_string("fn get_heap_offset() -> Int {\n")
  sb.write_string("  mem_load32(0)\n")
  sb.write_string("}\n\n")
  sb.write_string("///| Set heap offset\n")
  sb.write_string("fn set_heap_offset(offset : Int) -> Unit {\n")
  sb.write_string("  mem_store32(0, offset)\n")
  sb.write_string("}\n\n")
  sb.write_string("///| Initialize heap if needed\n")
  sb.write_string("fn ensure_heap_init() -> Unit {\n")
  sb.write_string("  if get_heap_offset() == 0 {\n")
  sb.write_string("    set_heap_offset(heap_base)\n")
  sb.write_string("  }\n")
  sb.write_string("}\n\n")

  // cabi_realloc implementation using linear memory
  sb.write_string("///| Canonical ABI realloc function\n")
  sb.write_string("///| Called by host to allocate memory for passing data\n")
  sb.write_string("pub fn cabi_realloc(\n")
  sb.write_string("  _old_ptr : Int,\n")
  sb.write_string("  _old_size : Int,\n")
  sb.write_string("  align : Int,\n")
  sb.write_string("  new_size : Int,\n")
  sb.write_string(") -> Int {\n")
  sb.write_string("  ensure_heap_init()\n")
  sb.write_string("  let offset = get_heap_offset()\n")
  sb.write_string("  // Align offset\n")
  sb.write_string("  let aligned = (offset + align - 1) & -(align)\n")
  sb.write_string("  let new_offset = aligned + new_size\n")
  sb.write_string("  // Grow memory if needed (64KB pages)\n")
  sb.write_string("  let pages_needed = (new_offset + 65535) / 65536\n")
  sb.write_string("  let current_pages = mem_size()\n")
  sb.write_string("  if pages_needed > current_pages {\n")
  sb.write_string(
    "    let grow_result = mem_grow(pages_needed - current_pages)\n",
  )
  sb.write_string("    if grow_result == -1 {\n")
  sb.write_string("      abort(\"cabi_realloc: memory grow failed\")\n")
  sb.write_string("    }\n")
  sb.write_string("  }\n")
  sb.write_string("  set_heap_offset(new_offset)\n")
  sb.write_string("  aligned\n")
  sb.write_string("}\n\n")

  // Reset allocator (for testing/debugging)
  sb.write_string("///| Reset the allocator (useful between calls)\n")
  sb.write_string("pub fn cabi_reset() -> Unit {\n")
  sb.write_string("  set_heap_offset(heap_base)\n")
  sb.write_string("}\n\n")

  // String lifting (ptr+len -> String)
  sb.write_string("///| Lift a string from linear memory\n")
  sb.write_string("pub fn cabi_lift_string(ptr : Int, len : Int) -> String {\n")
  sb.write_string("  let bytes : Array[Byte] = Array::new(capacity=len)\n")
  sb.write_string("  for i in 0..<len {\n")
  sb.write_string("    bytes.push(mem_load8(ptr + i).to_byte())\n")
  sb.write_string("  }\n")
  sb.write_string("  @utf8.decode_lossy(Bytes::from_array(bytes[:])[:])\n")
  sb.write_string("}\n\n")

  // String lowering (String -> writes to memory, returns ptr)
  sb.write_string("///| Lower a string to linear memory, returns (ptr, len)\n")
  sb.write_string("pub fn cabi_lower_string(s : String) -> (Int, Int) {\n")
  sb.write_string("  let bytes = @utf8.encode(s)\n")
  sb.write_string("  let len = bytes.length()\n")
  sb.write_string("  let ptr = cabi_realloc(0, 0, 1, len)\n")
  sb.write_string("  for i in 0..<len {\n")
  sb.write_string("    mem_store8(ptr + i, bytes[i].to_int())\n")
  sb.write_string("  }\n")
  sb.write_string("  (ptr, len)\n")
  sb.write_string("}\n\n")

  // Read/write primitives for linear memory (wrapper functions)
  sb.write_string("///| Read i32 from linear memory\n")
  sb.write_string("pub fn cabi_read_i32(ptr : Int) -> Int {\n")
  sb.write_string("  mem_load32(ptr)\n")
  sb.write_string("}\n\n")
  sb.write_string("///| Write i32 to linear memory\n")
  sb.write_string("pub fn cabi_write_i32(ptr : Int, val : Int) -> Unit {\n")
  sb.write_string("  mem_store32(ptr, val)\n")
  sb.write_string("}\n\n")

  // u8 read/write
  sb.write_string("///| Read u8 from linear memory\n")
  sb.write_string("pub fn cabi_read_u8(ptr : Int) -> Byte {\n")
  sb.write_string("  mem_load8(ptr).to_byte()\n")
  sb.write_string("}\n\n")
  sb.write_string("///| Write u8 to linear memory\n")
  sb.write_string("pub fn cabi_write_u8(ptr : Int, val : Byte) -> Unit {\n")
  sb.write_string("  mem_store8(ptr, val.to_int())\n")
  sb.write_string("}\n\n")

  // i64 read/write
  sb.write_string("///| Read i64 from linear memory\n")
  sb.write_string("pub fn cabi_read_i64(ptr : Int) -> Int64 {\n")
  sb.write_string("  mem_load64(ptr)\n")
  sb.write_string("}\n\n")
  sb.write_string("///| Write i64 to linear memory\n")
  sb.write_string("pub fn cabi_write_i64(ptr : Int, val : Int64) -> Unit {\n")
  sb.write_string("  mem_store64(ptr, val)\n")
  sb.write_string("}\n\n")

  // f32 read/write
  sb.write_string("///| Read f32 from linear memory\n")
  sb.write_string("pub fn cabi_read_f32(ptr : Int) -> Float {\n")
  sb.write_string("  mem_load_f32(ptr)\n")
  sb.write_string("}\n\n")
  sb.write_string("///| Write f32 to linear memory\n")
  sb.write_string("pub fn cabi_write_f32(ptr : Int, val : Float) -> Unit {\n")
  sb.write_string("  mem_store_f32(ptr, val)\n")
  sb.write_string("}\n\n")

  // f64 read/write
  sb.write_string("///| Read f64 from linear memory\n")
  sb.write_string("pub fn cabi_read_f64(ptr : Int) -> Double {\n")
  sb.write_string("  mem_load_f64(ptr)\n")
  sb.write_string("}\n\n")
  sb.write_string("///| Write f64 to linear memory\n")
  sb.write_string("pub fn cabi_write_f64(ptr : Int, val : Double) -> Unit {\n")
  sb.write_string("  mem_store_f64(ptr, val)\n")
  sb.write_string("}\n\n")

  // Flags read/write (as u32 bitmask)
  sb.write_string("///| Read flags bitmask from linear memory\n")
  sb.write_string("pub fn cabi_read_flags(ptr : Int) -> Int {\n")
  sb.write_string("  mem_load32(ptr)\n")
  sb.write_string("}\n\n")
  sb.write_string("///| Write flags bitmask to linear memory\n")
  sb.write_string("pub fn cabi_write_flags(ptr : Int, val : Int) -> Unit {\n")
  sb.write_string("  mem_store32(ptr, val)\n")
  sb.write_string("}\n")
  let path = match self.opts.out_dir {
    Some(out) => out + "/" + self.opts.gen_dir + "/cabi/cabi.mbt"
    None => self.opts.gen_dir + "/cabi/cabi.mbt"
  }
  self.output.push({ path, content: sb.to_string(), is_stub: false })

  // Generate moon.pkg (JSON or DSL format)
  self.generate_cabi_pkg()
}

///|
fn Generator::generate_cabi_pkg(self : Generator) -> Unit {
  let sb = StringBuilder::new()
  let filename = match self.opts.pkg_format {
    Json => {
      sb.write_string("{\n")
      sb.write_string("  \"import\": [\n")
      sb.write_string("    \"moonbitlang/core/encoding/utf8\"\n")
      sb.write_string("  ],\n")
      sb.write_string("  \"link\": {\n")
      sb.write_string("    \"wasm\": {\n")
      sb.write_string("      \"exports\": [\n")
      sb.write_string("        \"cabi_realloc:cabi_realloc\"\n")
      sb.write_string("      ]\n")
      sb.write_string("    },\n")
      sb.write_string("    \"wasm-gc\": {\n")
      sb.write_string("      \"exports\": [\n")
      sb.write_string("        \"cabi_realloc:cabi_realloc\"\n")
      sb.write_string("      ]\n")
      sb.write_string("    }\n")
      sb.write_string("  }\n")
      sb.write_string("}\n")
      "moon.pkg.json"
    }
    Dsl => {
      sb.write_string("import(\n")
      sb.write_string("  \"moonbitlang/core/encoding/utf8\",\n")
      sb.write_string(")\n\n")
      sb.write_string("options(\n")
      sb.write_string("  link: {\n")
      sb.write_string("    \"wasm\": {\n")
      sb.write_string("      \"exports\": [\n")
      sb.write_string("        \"cabi_realloc:cabi_realloc\",\n")
      sb.write_string("      ],\n")
      sb.write_string("    },\n")
      sb.write_string("    \"wasm-gc\": {\n")
      sb.write_string("      \"exports\": [\n")
      sb.write_string("        \"cabi_realloc:cabi_realloc\",\n")
      sb.write_string("      ],\n")
      sb.write_string("    },\n")
      sb.write_string("  },\n")
      sb.write_string(")\n")
      "moon.pkg"
    }
  }
  let path = match self.opts.out_dir {
    Some(out) => out + "/" + self.opts.gen_dir + "/cabi/" + filename
    None => self.opts.gen_dir + "/cabi/" + filename
  }
  self.output.push({ path, content: sb.to_string(), is_stub: false })
}
