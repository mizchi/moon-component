/// WKG (WebAssembly Package Manager) utilities for wa.dev registry

///|
/// WKG Registry configuration
pub struct WkgRegistry {
  base_url : String
} derive(Show)

///|
pub fn WkgRegistry::default() -> WkgRegistry {
  { base_url: "https://wa.dev" }
}

///|
pub fn WkgRegistry::new(base_url : String) -> WkgRegistry {
  { base_url, }
}

///|
/// Package reference for wa.dev
pub struct PackageRef {
  ns : String
  name : String
  version : String?
} derive(Show, Eq)

///|
pub fn PackageRef::new(
  ns : String,
  name : String,
  version : String?,
) -> PackageRef {
  { ns, name, version }
}

///|
/// Parse package reference from string like "wasi:http@0.2.0"
pub fn PackageRef::parse(s : String) -> PackageRef? {
  // Split by @ for version
  let at_parts : Array[String] = s
    .split("@")
    .map(fn(sv) { sv.to_string() })
    .collect()
  let name_part = at_parts[0]
  let version : String? = if at_parts.length() > 1 {
    Some(at_parts[1])
  } else {
    None
  }

  // Split by : for namespace
  let colon_parts : Array[String] = name_part
    .split(":")
    .map(fn(sv) { sv.to_string() })
    .collect()
  if colon_parts.length() >= 2 {
    Some({ ns: colon_parts[0], name: colon_parts[1], version })
  } else {
    None
  }
}

///|
pub fn PackageRef::to_string(self : PackageRef) -> String {
  let sb = StringBuilder::new()
  sb.write_string(self.ns)
  sb.write_string(":")
  sb.write_string(self.name)
  match self.version {
    Some(v) => {
      sb.write_string("@")
      sb.write_string(v)
    }
    None => ()
  }
  sb.to_string()
}

///|
/// Get the wa.dev package URL
pub fn WkgRegistry::package_url(self : WkgRegistry, pkg : PackageRef) -> String {
  let sb = StringBuilder::new()
  sb.write_string(self.base_url)
  sb.write_string("/")
  sb.write_string(pkg.ns)
  sb.write_string(":")
  sb.write_string(pkg.name)
  match pkg.version {
    Some(v) => {
      sb.write_string("@")
      sb.write_string(v)
    }
    None => ()
  }
  sb.to_string()
}

///|
/// Get the download URL for a package's WIT files
pub fn WkgRegistry::wit_url(self : WkgRegistry, pkg : PackageRef) -> String {
  let sb = StringBuilder::new()
  sb.write_string(self.base_url)
  sb.write_string("/v1/")
  sb.write_string(pkg.ns)
  sb.write_string("/")
  sb.write_string(pkg.name)
  match pkg.version {
    Some(v) => {
      sb.write_string("/")
      sb.write_string(v)
    }
    None => ()
  }
  sb.write_string("/wit")
  sb.to_string()
}

///|
/// Command to fetch package using wkg CLI
pub fn wkg_fetch_command(pkg : PackageRef, output_dir : String) -> String {
  let sb = StringBuilder::new()
  sb.write_string("wkg wit fetch ")
  sb.write_string(pkg.ns)
  sb.write_string(":")
  sb.write_string(pkg.name)
  match pkg.version {
    Some(v) => {
      sb.write_string("@")
      sb.write_string(v)
    }
    None => ()
  }
  sb.write_string(" -o ")
  sb.write_string(output_dir)
  sb.to_string()
}

///|
/// Generate shell script to fetch all dependencies
pub fn generate_fetch_script(
  deps : Array[PackageRef],
  wit_dir : String,
) -> String {
  let sb = StringBuilder::new()
  sb.write_string("#!/bin/bash\n")
  sb.write_string("# Fetch WIT dependencies from wa.dev\n")
  sb.write_string("# Generated by wit-bindgen-moonbit\n\n")
  sb.write_string("set -e\n\n")
  sb.write_string("WIT_DIR=\"")
  sb.write_string(wit_dir)
  sb.write_string("\"\n")
  sb.write_string("mkdir -p \"$WIT_DIR/deps\"\n\n")
  for dep in deps {
    sb.write_string("echo \"Fetching ")
    sb.write_string(dep.to_string())
    sb.write_string("...\"\n")
    sb.write_string("wkg wit fetch ")
    sb.write_string(dep.ns)
    sb.write_string(":")
    sb.write_string(dep.name)
    match dep.version {
      Some(v) => {
        sb.write_string("@")
        sb.write_string(v)
      }
      None => ()
    }
    sb.write_string(" -o \"$WIT_DIR/deps/")
    sb.write_string(dep.ns)
    sb.write_string("_")
    sb.write_string(dep.name)
    sb.write_string("\"\n\n")
  }
  sb.write_string("echo \"Done fetching dependencies.\"\n")
  sb.to_string()
}

///|
/// WKG lock file entry
pub struct WkgLockEntry {
  ns : String
  name : String
  version : String
  integrity : String?
} derive(Show, Eq, ToJson)

///|
/// Generate wkg.lock content
pub fn generate_wkg_lock(entries : Array[WkgLockEntry]) -> String {
  let sb = StringBuilder::new()
  sb.write_string("# wkg.lock - Generated by wit-bindgen-moonbit\n")
  sb.write_string("# Do not edit manually\n\n")
  sb.write_string("version = 1\n\n")
  for entry in entries {
    sb.write_string("[[package]]\n")
    sb.write_string("name = \"")
    sb.write_string(entry.ns)
    sb.write_string(":")
    sb.write_string(entry.name)
    sb.write_string("\"\n")
    sb.write_string("version = \"")
    sb.write_string(entry.version)
    sb.write_string("\"\n")
    match entry.integrity {
      Some(hash) => {
        sb.write_string("integrity = \"")
        sb.write_string(hash)
        sb.write_string("\"\n")
      }
      None => ()
    }
    sb.write_string("\n")
  }
  sb.to_string()
}
