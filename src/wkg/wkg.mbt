/// WKG (WebAssembly Package Manager) utilities for wa.dev registry

///|
/// WKG Registry configuration
pub struct WkgRegistry {
  base_url : String
} derive(Show)

///|
pub fn WkgRegistry::default() -> WkgRegistry {
  { base_url: "https://wa.dev" }
}

///|
pub fn WkgRegistry::new(base_url : String) -> WkgRegistry {
  { base_url, }
}

///|
/// Get the wa.dev package URL
pub fn WkgRegistry::package_url(
  self : WkgRegistry,
  pkg : @resolve.PackageName,
) -> String {
  let sb = StringBuilder::new()
  sb.write_string(self.base_url)
  sb.write_string("/")
  sb.write_string(pkg.to_string())
  sb.to_string()
}

///|
/// Get the download URL for a package's WIT files
pub fn WkgRegistry::wit_url(
  self : WkgRegistry,
  pkg : @resolve.PackageName,
) -> String {
  let sb = StringBuilder::new()
  sb.write_string(self.base_url)
  sb.write_string("/v1/")
  sb.write_string(pkg.ns)
  sb.write_string("/")
  sb.write_string(pkg.name)
  match pkg.version {
    Some(v) => {
      sb.write_string("/")
      sb.write_string(v)
    }
    None => ()
  }
  sb.write_string("/wit")
  sb.to_string()
}

///|
/// Command to fetch package using wkg CLI
pub fn wkg_fetch_command(
  pkg : @resolve.PackageName,
  output_dir : String,
) -> String {
  let sb = StringBuilder::new()
  sb.write_string("wkg wit fetch ")
  sb.write_string(pkg.to_string())
  sb.write_string(" -o ")
  sb.write_string(output_dir)
  sb.to_string()
}

///|
/// Generate shell script to fetch all dependencies
pub fn generate_fetch_script(
  deps : Array[@resolve.PackageName],
  wit_dir : String,
) -> String {
  let sb = StringBuilder::new()
  sb.write_string("#!/bin/bash\n")
  sb.write_string("# Fetch WIT dependencies from wa.dev\n")
  sb.write_string("# Generated by wit-bindgen-moonbit\n\n")
  sb.write_string("set -e\n\n")
  sb.write_string("WIT_DIR=\"")
  sb.write_string(wit_dir)
  sb.write_string("\"\n")
  sb.write_string("mkdir -p \"$WIT_DIR/deps\"\n\n")
  for dep in deps {
    sb.write_string("echo \"Fetching ")
    sb.write_string(dep.to_string())
    sb.write_string("...\"\n")
    sb.write_string("wkg wit fetch ")
    sb.write_string(dep.to_string())
    sb.write_string(" -o \"$WIT_DIR/deps/")
    sb.write_string(dep.ns)
    sb.write_string("_")
    sb.write_string(dep.name)
    sb.write_string("\"\n\n")
  }
  sb.write_string("echo \"Done fetching dependencies.\"\n")
  sb.to_string()
}
